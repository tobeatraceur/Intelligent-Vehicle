/********************************************Copyright******************************************************
**                                                                                                      
**
**-------------------------------------------文件信息-------------------------------------------------------
** 文件名称:			Wp_IIC.c
** 最后修订日期:  		2012-10-10
** 最后版本:			1.0
** 描述:				IIC初始化函数;
**						IO口模拟IIC通讯方式操作MPU6050;
**	
**-----------------------------------------------------------------------------------------------------------
** 创建人:				吴康
** 创建日期:			2012-02-09
** 版本:				1.0
** 描述:				IIC初始化函数;
**						IO口模拟IIC通讯方式操作MPU6050;
**						
**-----------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
** 版本:
** 描述:
**
**-----------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
** 版本:
** 描述:
**
*************************************************************************************************************/
#include "Wp_IIC.h"


/*************************************************************************************************************
** 函数名称:			I2C_delay
**
** 函数描述:			IIC操作使用延时函数;
** 						
**					    
** 输入变量:			void;
** 返回值:				void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
static void I2C_delay(void)
{
//  volatile int i = 7;
    uint8_t i = 7;
    
    while (i)
    {
        i--;
    }
}


/*************************************************************************************************************
** 函数名称:			I2C_Start
**
** 函数描述:			IIC启动;
** 						
**					    
** 输入变量:			void;
** 返回值:				bool;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
static bool I2C_Start(void)
{
    SDA_H;
    SCL_H;
    I2C_delay();
    
    if (!SDA_read)
        return false;
    
    SDA_L;
    I2C_delay();
    
    if (SDA_read)
        return false;
    
    SDA_L;
    I2C_delay();
    
    return true;
}


/*************************************************************************************************************
** 函数名称:			I2C_Stop
**
** 函数描述:			IIC停止;
** 						
**					    
** 输入变量:			void;
** 返回值:				void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
static void I2C_Stop(void)
{
    SCL_L;
    I2C_delay();
    SDA_L;
    I2C_delay();
    SCL_H;
    I2C_delay();
    SDA_H;
    I2C_delay();
}


/*************************************************************************************************************
** 函数名称:			I2C_Ack
**
** 函数描述:			IIC应答;
** 						
**					    
** 输入变量:			void;
** 返回值:				void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
static void I2C_Ack(void)
{
    SCL_L;
    I2C_delay();
    SDA_L;
    I2C_delay();
    SCL_H;
    I2C_delay();
    SCL_L;
    I2C_delay();
}


/*************************************************************************************************************
** 函数名称:			I2C_NoAck
**
** 函数描述:			IIC非应答;
** 						
**					    
** 输入变量:			void;
** 返回值:				void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
static void I2C_NoAck(void)
{
    SCL_L;
    I2C_delay();
    SDA_H;
    I2C_delay();
    SCL_H;
    I2C_delay();
    SCL_L;
    I2C_delay();
}


/*************************************************************************************************************
** 函数名称:			I2C_WaitAck
**
** 函数描述:			IIC等待应答;
** 						
**					    
** 输入变量:			void;
** 返回值:				bool;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
static bool I2C_WaitAck(void)
{
    SCL_L;
    I2C_delay();
    SDA_H;
    I2C_delay();
    SCL_H;
    I2C_delay();
    
    if (SDA_read) 
    {
        SCL_L;
        
        return false;
    }
    
    SCL_L;
    
    return true;
}


/*************************************************************************************************************
** 函数名称:			I2C_SendByte
**
** 函数描述:			IIC发送一个字节;
** 						
**					    
** 输入变量:			uint8_t byte;
** 返回值:				void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
static void I2C_SendByte(uint8_t byte)
{
    uint8_t i = 8;
    
    while (i--) 
    {
        SCL_L;
        I2C_delay();
        
        if (byte & 0x80)
            SDA_H;
        else
            SDA_L;
        
        byte <<= 1;
        I2C_delay();
        SCL_H;
        I2C_delay();
    }
    
    SCL_L;
}


/*************************************************************************************************************
** 函数名称:			I2C_ReceiveByte
**
** 函数描述:			IIC接收一个字节;
** 						
**					    
** 输入变量:			void;
** 返回值:				uint8_t;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
static uint8_t I2C_ReceiveByte(void)
{
    uint8_t i = 8;
    uint8_t byte = 0;

    SDA_H;
    while (i--) 
    {
        byte <<= 1;
        
        SCL_L;
        I2C_delay();
        SCL_H;
        I2C_delay();
        
        if (SDA_read) 
        {
            byte |= 0x01;
        }
    }
    
    SCL_L;
    
    return byte;
}


/*************************************************************************************************************
** 函数名称:			i2cWrite
**
** 函数描述:			IIC写数据;
** 						
**					    
** 输入变量:			uint8_t addr, uint8_t reg, uint8_t data;
** 返回值:				bool;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
bool i2cWrite(uint8_t addr, uint8_t reg, uint8_t data)
{
    if (!I2C_Start())
        return false;
    
    I2C_SendByte(addr << 1 | I2C_Direction_Transmitter);
    if (!I2C_WaitAck()) 
    {
        I2C_Stop();
        
        return false;
    }
    I2C_SendByte(reg);
    I2C_WaitAck();
    I2C_SendByte(data);
    I2C_WaitAck();
    I2C_Stop();
    
    return true;
}


/*************************************************************************************************************
** 函数名称:			i2cWriteBuffer
**
** 函数描述:			IIC写数据;
** 						
**					    
** 输入变量:			uint8_t addr, uint8_t reg, uint8_t len, uint8_t *data;
** 返回值:				bool;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
static bool i2cWriteBuffer(uint8_t addr, uint8_t reg, uint8_t len, uint8_t *data)
{
    uint8_t i = 0;
    
    if (!I2C_Start())
        return false;
    
    I2C_SendByte(addr << 1 | I2C_Direction_Transmitter);
    if (!I2C_WaitAck()) 
    {
        I2C_Stop();
        
        return false;
    }
    I2C_SendByte(reg);
    I2C_WaitAck();
    for (i = 0; i < len; i++) 
    {
        I2C_SendByte(data[i]);
        
        if (!I2C_WaitAck()) 
        {
            I2C_Stop();
            
            return false;
        }
    }
    
    I2C_Stop();
    
    return true;
}


/*************************************************************************************************************
** 函数名称:			i2cwrite
**
** 函数描述:			IIC写数据;
** 						
**					    
** 输入变量:			uint8_t addr, uint8_t reg, uint8_t len, uint8_t *data;
** 返回值:				int8_t;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
int8_t i2cwrite(uint8_t addr, uint8_t reg, uint8_t len, uint8_t *data)
{
	if (i2cWriteBuffer(addr, reg, len, data))
	{
		return TRUE;
	}
	else
	{
		return FALSE;
	}
//	return FALSE;
}


/*************************************************************************************************************
** 函数名称:			i2cRead
**
** 函数描述:			IIC读数据;
** 						
**					    
** 输入变量:			uint8_t addr, uint8_t reg, uint8_t len, uint8_t *buf;
** 返回值:				bool;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
static bool i2cRead(uint8_t addr, uint8_t reg, uint8_t len, uint8_t *buf)
{
    if (!I2C_Start())
        return false;
    
    I2C_SendByte(addr << 1 | I2C_Direction_Transmitter);
    if (!I2C_WaitAck()) 
    {
        I2C_Stop();
        
        return false;
    }
    I2C_SendByte(reg);
    I2C_WaitAck();
    I2C_Start();
    I2C_SendByte(addr << 1 | I2C_Direction_Receiver);
    I2C_WaitAck();
    while (len) 
    {
        *buf = I2C_ReceiveByte();
        
        if (len == 1)
            I2C_NoAck();
        else
            I2C_Ack();
        
        buf++;
        len--;
    }
    
    I2C_Stop();
    
    return true;
}


/*************************************************************************************************************
** 函数名称:			i2cread
**
** 函数描述:			IIC读数据;
** 						
**					    
** 输入变量:			uint8_t addr, uint8_t reg, uint8_t len, uint8_t *buf;
** 返回值:				int8_t;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
int8_t i2cread(uint8_t addr, uint8_t reg, uint8_t len, uint8_t *buf)
{
	if (i2cRead(addr, reg, len, buf))
	{
		return TRUE;
	}
	else
	{
		return FALSE;
	}
//	return FALSE;
}


/*************************************************************************************************************
** 函数名称:			i2cGetErrorCounter
**
** 函数描述:			
** 						
**					    
** 输入变量:			void;
** 返回值:				uint8_t;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
uint8_t i2cGetErrorCounter(void)
{
    return 0;           // TODO maybe fix this, but since this is test code, doesn't matter.
}


/*************************************************************************************************************
** 函数名称:			SimulateI2cInit
**
** 函数描述:			IIC端口初始化;
** 						
**					    
** 输入变量:			void;
** 返回值:				void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:				
** 创建日期:			2011-11-1
**-------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**-------------------------------------------------------------------------------------------------------------
***************************************************************************************************************/
void SimulateI2cInit(void)
{
    GPIO_InitTypeDef GPIO_InitStructure;
    
    /*  PC8，PC9配置为开漏输出，作为模拟IIC接口 */
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_8 | GPIO_Pin_9;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_OD;        // 普通开漏输出
    GPIO_Init(GPIOC, &GPIO_InitStructure);
}


/********************************************************************************************************
**                            End Of File
********************************************************************************************************/
